<!doctype html>
<html lang="en-us">
  <head>
    <title>AKS PowerShell Tip - Add Authorized Ip // Notes from a system engineer&#39;s desk</title>
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.65.3" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Deepak Singh Dhami" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="https://dexterposh.github.io/css/main.min.6771f69a4cfbbdc6c8cfbcff2d6dfc6fe413957aa52d065a017cae25be619595.css" />

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-165270256-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="AKS PowerShell Tip - Add Authorized Ip"/>
<meta name="twitter:description" content="Background üêº Recently, I found out that there is no sane way to perform adding a public IP address to the authorized IP address ranges using either the Az CLI or Az.Aks PowerShell (no cmdlets available yet) module.
From the official docs it says to use something like below format with Az CLI.
az aks update \  --resource-group myResourceGroup \  --name myAKSCluster \  --api-server-authorized-ip-ranges 73.140.245.0/24 But it doesn&rsquo;t tell you how to append the IP to the range, instead you need to supply a comma separated value of public IP addresses."/>

    <meta property="og:title" content="AKS PowerShell Tip - Add Authorized Ip" />
<meta property="og:description" content="Background üêº Recently, I found out that there is no sane way to perform adding a public IP address to the authorized IP address ranges using either the Az CLI or Az.Aks PowerShell (no cmdlets available yet) module.
From the official docs it says to use something like below format with Az CLI.
az aks update \  --resource-group myResourceGroup \  --name myAKSCluster \  --api-server-authorized-ip-ranges 73.140.245.0/24 But it doesn&rsquo;t tell you how to append the IP to the range, instead you need to supply a comma separated value of public IP addresses." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://dexterposh.github.io/posts/005-aks-tip-ip/" />
<meta property="article:published_time" content="2020-05-01T12:21:28+05:30" />
<meta property="article:modified_time" content="2020-05-01T12:21:28+05:30" />


  </head>
  <body>
    <header class="app-header">
      <a href="https://dexterposh.github.io/"><img class="app-header-avatar" src="/avatar.jpg" alt="Deepak Singh Dhami" /></a>
      <h1>Notes from a system engineer&#39;s desk</h1>
      <p>Dev?Ops</p>
      <div class="app-header-social">
        
          <a target="_blank" href="https://github.com/dexterposh" rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>github</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg></a>
        
          <a target="_blank" href="https://twitter.com/dexterposh" rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter">
  <title>twitter</title>
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
</svg></a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">AKS PowerShell Tip - Add Authorized Ip</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          May 1, 2020
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          2 min read
        </div><div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg>
          <a class="tag" href="https://dexterposh.github.io/tags/aks/">aks</a><a class="tag" href="https://dexterposh.github.io/tags/azure/">azure</a><a class="tag" href="https://dexterposh.github.io/tags/api/">api</a><a class="tag" href="https://dexterposh.github.io/tags/powershell/">powershell</a><a class="tag" href="https://dexterposh.github.io/tags/tip/">tip</a><a class="tag" href="https://dexterposh.github.io/tags/ip/">ip</a></div></div>
    </header>
    <div class="post-content">
      <h2 id="background-">Background üêº</h2>
<p>Recently, I found out that there is no sane way to perform adding a public IP address to
the authorized IP address ranges using either the
<a href="https://docs.microsoft.com/en-us/azure/aks/api-server-authorized-ip-ranges#update-a-clusters-api-server-authorized-ip-ranges">Az CLI</a>
or <a href="https://docs.microsoft.com/en-us/powershell/module/az.aks/?view=azps-3.8.0">Az.Aks</a> PowerShell (no cmdlets available yet) module.</p>
<p>From the official docs it says to use  something like below format with Az CLI.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">az aks update <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --resource-group myResourceGroup <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --name myAKSCluster <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --api-server-authorized-ip-ranges 73.140.245.0/24
</code></pre></div><p>But it doesn&rsquo;t tell you how to append the IP to the range, instead you need to
supply a comma separated value of public IP addresses.</p>
<h2 id="challenge-">Challenge ‚òÅ</h2>
<p>Well, this is can be done by using Az CLI with PowerShell or Bash and parsing
output then generating a comma separated string and passing it back to Az CLI
üòû</p>
<h2 id="solution-">Solution ‚ö°</h2>
<p>Often, when I am hit with such limitations with cmdlets or Az CLI making life
hard. I go back to using simply the 2 cmdlets provided by <em>Az.Resources</em> module.</p>
<p>Behold mighty!</p>
<ul>
<li><em>Get-AzResource</em> - Gets the Az resource</li>
<li><em>Set-AzResource</em> - Modifies the Az resource</li>
</ul>
<p>I ended up doing the below and creating a utility function out of it.</p>
<p>First, get the AKS Cluster resource. Make sure to specify the <strong>-ExpandProperties</strong>
switch to get back full fledged resource otherwise it returns a shallow instance.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">$ResourceGroup = <span style="color:#e6db74">&#34;test-aks-rg&#34;</span>
$Name = <span style="color:#e6db74">&#34;aksCluster001&#34;</span>
$IP = <span style="color:#e6db74">&#34;110.91.234.43&#34;</span>
$AksCluster = Get-AzResource -ResourceGroupName $ResourceGroup -Name $Name -ExpandProperties -ErrorAction Stop
</code></pre></div><p>Once you have the resource, walk-through the properties and append the IP (+=
operator in PowerShell) to the local copy of the resource.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">$orgClusterInfo.Properties.apiServerAccessProfile.authorizedIpRanges += $Ip

</code></pre></div><p>Finally, perform a Set operation by piping the modified local resource copy to
<strong>Set-AzResource</strong> cmdlet.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">$orgClusterInfo | Set-AzResource -ErrorAction Stop
</code></pre></div><h2 id="takeaway-">Takeaway üî•</h2>
<p>Even, when there are certain utility functions not available in the Az PowerShell
module. We can rely on the <em>`</em>-Resource* cmdlets to work our way through.</p>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
